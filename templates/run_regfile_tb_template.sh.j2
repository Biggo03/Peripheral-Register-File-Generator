{# templates/run_tb.sh.j2 #}
#!/usr/bin/env bash
set -euo pipefail

# ----------------------------
# Auto-generated runner script
# Peripheral: {{ peripheral_name }}
# ----------------------------

# Absolute/relative paths emitted by the generator
MACROS="{{ macro_path }}"
PKG="{{ package_path }}"
RTL="{{ rtl_path }}"
TB="{{ tb_path }}"

# Build products
BUILD_DIR="${BUILD_DIR:-build/{{ peripheral_name }}}"
OUT_ELF="${OUT_ELF:-${BUILD_DIR}/{{ peripheral_name }}_tb.vvp}"
LOG="${LOG:-${BUILD_DIR}/sim.log}"

# Tools (override with env vars if you want)
IVERILOG="${IVERILOG:-iverilog}"
VVP="${VVP:-vvp}"
GTKWAVE="${GTKWAVE:-gtkwave}"

# Optional: expected waveform path (your TB should create it)
# You can override from CLI: VCD=/path/to/file.vcd ./run_tb.sh
VCD="${VCD:-${BUILD_DIR}/waves.vcd}"

mkdir -p "${BUILD_DIR}"

echo "[INFO] Using:"
echo "  MACROS: ${MACROS}"
echo "  PKG:    ${PKG}"
echo "  RTL:    ${RTL}"
echo "  TB:     ${TB}"
echo "  BUILD:  ${BUILD_DIR}"
echo

# Basic sanity checks (fail fast with a useful message)
for f in "${MACROS}" "${PKG}" "${RTL}" "${TB}"; do
  if [[ ! -f "${f}" ]]; then
    echo "[ERROR] Missing file: ${f}" >&2
    exit 1
  fi
done

# Include search paths: directory of each generated file
INC_MACROS="$(dirname "${MACROS}")"
INC_PKG="$(dirname "${PKG}")"
INC_RTL="$(dirname "${RTL}")"
INC_TB="$(dirname "${TB}")"

# You can pass extra compile args via env var:
#   IVERILOG_ARGS="-DDEBUG -Wall" ./run_tb.sh
IVERILOG_ARGS="${IVERILOG_ARGS:-}"

# You can pass runtime plusargs via env var:
#   PLUSARGS="+seed=1 +vcd={{ peripheral_name }}.vcd" ./run_tb.sh
PLUSARGS="${PLUSARGS:-}"

echo "[INFO] Compiling (iverilog)..."
set -x
"${IVERILOG}" -g2012 \
  -I "${INC_MACROS}" -I "${INC_PKG}" -I "${INC_RTL}" -I "${INC_TB}" \
  ${IVERILOG_ARGS} \
  -o "${OUT_ELF}" \
  "${MACROS}" \
  "${PKG}" \
  "${RTL}" \
  "${TB}"
set +x

echo
echo "[INFO] Running (vvp)..."
echo "[INFO] Log: ${LOG}"
set -x
"${VVP}" "${OUT_ELF}" ${PLUSARGS} | tee "${LOG}"
set +x

echo
if [[ -f "${VCD}" ]]; then
  echo "[INFO] Waveform: ${VCD}"
else
  echo "[WARN] No VCD found at: ${VCD}"
  echo "       If your TB dumps to a different name/path, set VCD=... when running."
fi

# Optional convenience: ./run_tb.sh --wave
if [[ "${1:-}" == "--wave" ]]; then
  if [[ -f "${VCD}" ]]; then
    exec "${GTKWAVE}" "${VCD}"
  else
    echo "[ERROR] --wave requested but VCD not found: ${VCD}" >&2
    exit 1
  fi
fi

echo "[INFO] Done."
